#!/bin/bash

# blade - The Official CLI for Infrablade Sync

COMMAND=$1

function show_help {
    echo "Usage: ./blade [command]"
    echo ""
    echo "Commands:"
    echo "  install     Download/Update the latest engine image"
    echo "  start       Start the sync engine (requires key.json)"
    echo "  stop        Stop the sync engine"
    echo "  logs        Show live logs"
    echo "  status      Check if engine is running"
}

case $COMMAND in
    start)
        echo "üöÄ Starting Infrablade Engine..."
        if [ ! -f "./key.json" ]; then
            echo "‚ùå Error: key.json not found in current folder."
            echo "   Please place your Firebase Service Account key here and rename it to 'key.json'."
            exit 1
        fi
        
        # Stop any old version first
        docker rm -f infrablade-sync 2>/dev/null
        
        # Run the new container
        docker run -d \
          -p 3000:3000 \
          --name infrablade-sync \
          -v "$(pwd)/key.json:/app/key.json" \
          -e FIREBASE_CREDENTIALS="/app/key.json" \
          chr16/sync-engine:latest
          
        echo "‚úÖ Engine started on port 3000."
        echo "   View logs with: ./blade logs"
        ;;
        
    stop)
        echo "üõë Stopping Engine..."
        docker stop infrablade-sync && docker rm infrablade-sync
        echo "   Engine stopped."
        ;;
        
    logs)
        docker logs -f infrablade-sync
        ;;
        
    status)
        docker ps --filter "name=infrablade-sync"
        ;;
        
    install)
        echo "‚¨áÔ∏è  Pulling latest version from Docker Hub..."
        docker pull chr16/sync-engine:latest
        echo "‚úÖ Update complete."
        ;;
        
    *)
        show_help
        ;;
esac
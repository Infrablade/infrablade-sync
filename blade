#!/bin/bash

# blade - The Official CLI for Infrablade Sync

COMMAND=$1

function print_logo {
    echo "    ____        ____             __    __            __   "
    echo "   /  _/____   / __/_____ ____ _/ /_  / /____ _ ____/ /__ "
    echo "   / / / __ \ / /_ / ___// __ \`/ __ \/ // __ \`/ / __  / _ \\"
    echo " _/ / / / / // __// /   / /_/ / /_/ / // /_/ // /_/ /  __/"
    echo "/___//_/ /_//_/  /_/    \__,_/_.___/_/ \__,_/ \__,_/\___/ "
    echo "                                         v1.0 (Community)"
    echo ""
}

function show_help {
    print_logo
    echo "Usage: ./blade [command]"
    echo ""
    echo "Commands:"
    echo "  install     Download/Update the latest engine image"
    echo "  start       Start the sync engine"
    echo "  stop        Stop the sync engine"
    echo "  logs        Show live logs"
    echo "  status      Check if engine is running"
}

case $COMMAND in
    start)
        print_logo
        echo "[INIT] Loading configuration..."
        
        if [ ! -f "./key.json" ]; then
            echo "‚ùå Error: key.json not found in current folder."
            exit 1
        fi
        
        echo "[DOCK] Stopping old instances..."
        docker rm -f infrablade-sync 2>/dev/null
        
        echo "[CORE] Starting engine..."
        docker run -d \
          -p 3000:3000 \
          --name infrablade-sync \
          -v "$(pwd)/key.json:/app/key.json" \
          -e FIREBASE_CREDENTIALS="/app/key.json" \
          chr16/sync-engine:latest > /dev/null
          
        echo ""
        echo ">> üöÄ ENGINE OPERATIONAL. Listening on Port 3000."
        echo ">> Run './blade logs' to monitor connection."
        ;;
        
    stop)
        echo "üõë Stopping Engine..."
        docker stop infrablade-sync && docker rm infrablade-sync
        ;;
        
    logs)
        docker logs -f infrablade-sync
        ;;
        
    status)
        docker ps --filter "name=infrablade-sync"
        ;;
        
    install)
        echo "‚¨áÔ∏è  Pulling latest version..."
        docker pull chr16/sync-engine:latest
        ;;
        
    *)
        show_help
        ;;
esac
